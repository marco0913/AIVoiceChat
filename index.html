<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>AI Voice Chat</title>
    <style>
        body {
            font-family: Arial;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px
        }

        #chat-box {
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px
        }

        #message-input {
            width: 70%;
            padding: 8px
        }

        button {
            padding: 8px 15px;
            background: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer
        }

        button:disabled {
            background: #888;
            cursor: not-allowed
        }

        .user-message {
            text-align: right;
            color: blue;
            margin: 5px
        }

        .ai-message {
            text-align: left;
            color: green;
            margin: 5px
        }

        .system-message {
            text-align: center;
            color: gray;
            margin: 5px
        }
    </style>
</head>

<body>
    <h1>AI Voice Chat</h1>
    <div id="chat-box"></div>
    <input id="message-input" placeholder="Type your messageâ€¦" />
    <button id="send-btn">Send</button>
    <button id="stop-btn">Stop Voice</button>

    <script>
        const clientId = "chat_interface";
        const socket = new WebSocket(`ws://localhost:8000/ws/${clientId}`);
        const chatBox = document.getElementById("chat-box");
        const inputEl = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const stopBtn = document.getElementById("stop-btn");
        let currentAudio = null, lastUrl = null;

        socket.onopen = () => {
            addMessage("System", "Connected", "system");
        };

        socket.onmessage = event => {
            if (event.data instanceof Blob) {
                const url = URL.createObjectURL(event.data);
                lastUrl = url;
                currentAudio = new Audio(url);

                inputEl.disabled = true;
                sendBtn.disabled = true;

                currentAudio.addEventListener("ended", () => {
                    socket.send(JSON.stringify({ type: "ready_for_next" }));
                    inputEl.disabled = false;
                    sendBtn.disabled = false;
                    URL.revokeObjectURL(url);
                }, { once: true });

                currentAudio.play();
                addMessage("AI", "(voice response)", "ai");
            } else {
                addMessage("AI", event.data, "ai");
            }
        };

        socket.onerror = err => {
            addMessage("System", `Error: ${err.message}`, "system");
        };

        sendBtn.onclick = () => {
            const text = inputEl.value.trim();
            if (!text || socket.readyState !== WebSocket.OPEN) return;
            socket.send(JSON.stringify({ type: "message", text }));
            addMessage("You", text, "user");
            inputEl.value = "";
        };

        stopBtn.onclick = () => {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                socket.send(JSON.stringify({ type: "ready_for_next" }));
                inputEl.disabled = false;
                sendBtn.disabled = false;
                if (lastUrl) URL.revokeObjectURL(lastUrl);
            }
        };

        function addMessage(sender, text, cls) {
            const div = document.createElement("div");
            div.classList.add(`${cls}-message`);
            div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        inputEl.addEventListener("keypress", e => {
            if (e.key === "Enter") sendBtn.click();
        });
    </script>
</body>

</html>